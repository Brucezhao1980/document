#!/bin/bash
 
function menu()
{
echo -e "\033[1;31m ______________________________________________________________________________\033[0m"
echo -e "\033[1;31m|                                                                              |\033[0m"
echo -e "\033[1;31m|                                   I LOVE U                                   |\033[0m"
echo -e "\033[1;31m|______________________________________________________________________________|\033[0m"
echo -e "\033[1;31m      \                                  /                      /\033[0m"
echo -e "\033[1;31m       \     .                          /                      /            x\033[0m"
echo -e "\033[1;31m        \                              /                      /\033[0m"
echo -e "\033[1;31m         \                            /          +           /\033[0m"
echo -e "\033[1;31m          \            +             /                      /\033[0m"
echo -e "\033[1;31m           *                        /                      /\033[0m"
echo -e "\033[1;31m                                   /      .               /\033[0m"
echo -e "\033[1;31m    X                             /                      /            X\033[0m"
echo -e "\033[1;31m                                 /                     ###\033[0m"
echo -e "\033[1;31m                                /                     # % #\033[0m"
echo -e "\033[1;31m                               /                       ###\033[0m"
echo -e "\033[1;31m                      .       /\033[0m"
echo -e "\033[1;31m     .                       /      .            *           .\033[0m"
echo -e "\033[1;31m                            /\033[0m"
echo -e "\033[1;31m                           *\033[0m"
echo -e "\033[1;31m                  +                       *\033[0m"
echo -e "\033[1;31m"
echo -e "\033[1;31m                                       ^\033[0m"
echo -e "\033[1;31m                         鬼魅羊羔               ^\033[0m"
cat <<EOF
                `echo "1).webshell后门扫描："`
                `echo "2).网站日志分析："`
                `echo "3).日志搜索："`
                `echo "4).退出脚本："`
EOF
read -p "请选择要使用的功能：" num
case $num in
    1)
        webscan
    ;;
    2)
        logscan
    ;;
    3)
        super
    ;;
    4)
        exit
    ;;
esac
 
}
 
function webscan
{
echo "                       "
echo "( what are you doing? )"
echo  ---------------------
echo "      o   ^__^ "
echo "       o  (oo)\_______"
echo "          (__)\       )\/\  "
echo "              ||----w |  朝  " 
echo "              ||     ||  鲁 "
echo
echo "...."webshell扫描脚本v1.0"..."
echo "---------------------说明信息------------------------------------"
echo "字典格式推荐使用notepad++，将要扫描的内容改成unix格式并保存"
echo "内容特征为test|\$POST|\(\$_POST"
echo "-------------------------------------------------------------------"
echo "例如：/home/local/www/"
read -p "请选择要检查的网站路径：" filepath
read -p "特征码字典路径（默认回车）：" wordlist
if [ -z $filepath ];then
echo -e "\033[1;31m 请输入要扫描的路径！\033[0m"
webscan
elif [ -z $wordlist ];then
echo "---------------------扫描信息------------------------------------"
echo -e "\033[44;37m 网站路径：$filepath \033[0m"
echo -e "\033[44;37m 字典路径：$wordlist \033[0m"
echo "-------------------------------------------------------------------"
find $filepath -name "*.php"|xargs egrep "eval|<?php eval|GIF89a|_P\"\.\/\*-\/\*-\*\/\"OS\"\.|<?php \$_GET|base64_decode\($|array_map\(assert|array\(\$Base\(\$_POS|extract\(\$_REQUEST|eval\(\'@ini_set|ZXZhbCgnQGluaV9zZXQ|\'e\'\.\'v\'\.\'a\'\.\'l\'"  |grep -v "Binary"|awk -F ":" '{print $1 "    " "\033[45;37m 一句话后门 \033[0m"}'|uniq
find $filepath -name "*.php"|xargs egrep "一句话|小马|大马|挂马|提权|命令|文件管理|免杀|后门|system\(\$cmd\)|shell_exec\(\$cmd\)|\$cmd=socket|cmd|shellname|shell|webshell|f377368656c6c2e676f6f676c65636f6|explode\(|mysqlDll\.dll|exec sp_configure|xp_cmdshell|BackDoor|net user|eval\(gzunc|cmd\.exe|command|execfunc"|grep -v "Binary"|awk -F ":" '{print $1 "    " "\033[41;37m 疑似webshell大马 \033[0m"}'|uniq
find $filepath -name "*.php"|xargs egrep "共产党|博彩|澳门|六合彩|荷官|性感|一夜情|高潮|fangong|反共|激情|色情|发牌|共党"|awk -F ":" '{print $1 "    " "\033[41;37m 疑似带有敏感内容 \033[0m"}'|grep -v "Binary"|uniq
find $filepath -name "*.jsp"|xargs egrep "一句话|小马|大马|挂马|提权|命令|文件管理|免杀|后门|exec\(cmd|executeQuery|execute|RealVNC|cmd\.exe|\"nc |reg query|WinStations|RDP-Tcp|PortNumbe|execute|\'cmd\'|HashMap\(|Command Window|JFolder|exeCmd"|awk -F ":" '{print $1 "    " "\033[45;37m JSP后门 \033[0m"}'|grep -v "Binary"|uniq
find $filepath -name "*.jsp"|xargs egrep "共产党|博彩|澳门|六合彩|荷官|性感|一夜情|高潮|fangong|反共|激情|色情|发牌|共党"|awk -F ":" '{print $1 "    " "\033[41;37m 疑似带有敏感内容 \033[0m"}'|grep -v "Binary"|uniq
find $filepath -name "*.html"|xargs egrep "共产党|博彩|澳门|六合彩|荷官|性感|一夜情|高潮|fangong|反共|激情|色情|发牌|共党"|awk -F ":" '{print $1 "    " "\033[41;37m 疑似带有敏感内容 \033[0m"}'|grep -v "Binary"|uniq
find $filepath -name "*.html"|xargs egrep "QQ:|QQ|hacker|hack|hack by:|友情检测|吐司|黑客"|awk -F ":" '{print $1 "    " "\033[41;37m 疑似黑页 \033[0m"}'|grep -v "Binary"|uniq
find $filepath -name "*.txt"|xargs egrep "QQ:|QQ|hacker|hack|hack by:|友情检测|吐司|黑客|共产党|博彩|澳门|六合彩|荷官|性感|一夜情|高潮|fangong|反共|激情|色情|发牌|共党"|awk -F ":" '{print $1 "    " "\033[41;37m 疑似带有敏感内容 \033[0m"}'|grep -v "Binary"|uniq
echo "-------------------------------------------------------------------"
echo -e "\033[44;37m 扫描完毕！ \033[0m"
else
echo "---------------------扫描信息------------------------------------"
echo -e "\033[44;37m 网站路径：$filepath \033[0m"
echo -e "\033[44;37m 字典路径：$wordlist \033[0m"
echo "-------------------------------------------------------------------"
wordlist1=$(cat $wordlist)
find $filepath -name "*.php"|xargs egrep "$wordlist1"  |grep -v "Binary"|awk -F ":" '{print $1 "    " "\033[45;37m 一句话后门 \033[0m"}'|uniq
find $filepath -name "*.php"|xargs egrep "$wordlist1"|grep -v "Binary"|awk -F ":" '{print $1 "    " "\033[41;37m 疑似webshell大马 \033[0m"}'|uniq
find $filepath -name "*.php"|xargs egrep "$wordlist1"|awk -F ":" '{print $1 "    " "\033[41;37m 疑似带有敏感内容 \033[0m"}'|grep -v "Binary"|uniq
find $filepath -name "*.jsp"|xargs egrep "$wordlist1"|awk -F ":" '{print $1 "    " "\033[45;37m JSP后门 \033[0m"}'|grep -v "Binary"|uniq
find $filepath -name "*.jsp"|xargs egrep "$wordlist1"|awk -F ":" '{print $1 "    " "\033[41;37m 疑似带有敏感内容 \033[0m"}'|grep -v "Binary"|uniq
find $filepath -name "*.html"|xargs egrep "$wordlist1"|awk -F ":" '{print $1 "    " "\033[41;37m 疑似带有敏感内容 \033[0m"}'|grep -v "Binary"|uniq
find $filepath -name "*.html"|xargs egrep "$wordlist1"|awk -F ":" '{print $1 "    " "\033[41;37m 疑似黑页 \033[0m"}'|grep -v "Binary"|uniq
find $filepath -name "*.txt"|xargs egrep "$wordlist1"|awk -F ":" '{print $1 "    " "\033[41;37m 疑似带有敏感内容 \033[0m"}'|grep -v "Binary"|uniq
echo "-------------------------------------------------------------------"
echo -e "\033[44;37m 字典扫描完毕！ \033[0m"
echo "-------------------------------------------------------------------"
fi
}
menu
 
function logscan
{
echo -e "\033[1;35m[-] ***\033[0m"
echo -e "\033[1;31m                                                  \033[0m"
echo -e "\033[1;31m               .;lxO0KXXXK0Oxl:.\033[0m"
echo -e "\033[1;31m           ,o0WMMMMMMMMMMMMMMMMMMKd,\033[0m"                                       
echo -e "\033[1;31m        xNMMMMMMMMMMMMMMMMMMMMMMMMMWx,\033[0m "                                    
echo -e "\033[1;31m      :KMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMK:         \033[0m"                         
echo -e "\033[1;31m    .KMMMMMMMMMMMMMMMWNNNWMMMMMMMMMMMMMMMX,  \033[0m "                          
echo -e "\033[1;31m   lWMMMMMMMMMMMXd:..     ..;dKMMMMMMMMMMMMo \033[0m "                        
echo -e "\033[1;31m  xMMMMMMMMMMWd.               .oNMMMMMMMMMMk       \033[0m"                       
echo -e "\033[1;31m oMMMMMMMMMMx.                    dMMMMMMMMMMx       \033[0m"                      
echo -e "\033[1;31m.WMMMMMMMMM:                       :MMMMMMMMMM,        \033[0m"                    
echo -e "\033[1;31mxMMMMMMMMMo                         lMMMMMMMMMO        \033[0m "                    
echo -e "\033[1;31mNMMMMMMMMW                    ,cccccoMMMMMMMMMWlccccc;  \033[0m"                   
echo -e "\033[1;31mMMMMMMMMMX                     ;KMMMMMMMMMMMMMMMMMMX:     \033[0m"                 
echo -e "\033[1;31mNMMMMMMMMW.                      ;KMMMMMMMMMMMMMMX:       \033[0m"                 
echo -e "\033[1;31mxMMMMMMMMMd                        ,0MMMMMMMMMMK;        \033[0m"                  
echo -e "\033[1;31m.WMMMMMMMMMc                         OMMMMMM0,          \033[0m"                  
echo -e "\033[1;31m lMMMMMMMMMMk.                         .kMMO         \033[0m"                    
echo -e "\033[1;31m  dMMMMMMMMMMWd                         ..             \033[0m"                   
echo -e "\033[1;31m   cWMMMMMMMMMMMNxc.                ##########         \033[0m"                   
echo -e "\033[1;31m    .0MMMMMMMMMMMMMMMMWc            #+#    #+#\033[0m"
echo -e "\033[1;31m      ;0MMMMMMMMMMMMMMMo.          +:+\033[0m"
echo -e "\033[1;31m        .dNMMMMMMMMMMMMo          +#++:++#+\033[0m"
echo -e "\033[1;31m           oOWMMMMMMMMo                +:+\033[0m"
echo -e "\033[1;31m               .,cdkO0K;        :+:    :+:             \033[0m"                  
echo -e "\033[1;31m                                :::::::+:\033[0m"
echo -e "                      \033[1;35m....中间件日志分析脚本v2.0...\033[0m"
echo "...."中间件日志分析脚本v2.0"..."
echo ------------------------------------------------------------
echo "自动分析中间件日志，并将日志中存在的SQL注入、XSS脚本攻击等攻击行为筛选出来"
echo "本脚本目前仅支持IIS、apache、weblogic中间件"
read -p "请输入结果保存路径：" file2
if [ -e "$file2" ];then
mkdir -p $file2/log/ $file2/ip/
else
mkdir -p $file2 $file2/log/ $file2/ip/
fi
echo "分析结果日志保存在$file2/log/目录下"
read -p "请输入日志路径：" filepath2
if ls -ltr $filepath2|egrep "access";then
echo "开始进行分析......"
echo ------------------------SQL注入攻击sql.log----------------
echo "开始分析存在SQL注入的攻击行为，并将结果保存在$file2/log/目录下"
more $filepath2/access*.* |egrep "+union+|%20select%20|%20and%201=1|%20and%201=2|%20exec|%27exec| information_schema.tables|%20information_schema.tables|%20where%20|%20union%20|%20SELECT%20|%2ctable_name%20|cmdshell|%20table_schema" >$file2/log/sql.log
echo "分析结束"
awk '{print "共检测到SQL注入攻击" NR"次"}' $file2/log/sql.log|tail -n1
echo "开始统计SQL注入攻击事件中，出现频率最多的前20个IP地址"
cat $file2/log/sql.log |awk -F "[" '{print $1}' |sort |uniq -c |sort -rn |head -20 >$file2/ip/sqlip.log
echo ----------------------------------------------------------
more $file2/ip/sqlip.log
echo "统计结束"
echo -------------------------扫描器scan.log-------------------
echo "开始分析存在扫描的攻击行为，并将结果保存在$file2/log/目录下"
more /usr/access*.* |egrep "sqlmap|acunetix|Netsparker|nmap" >$file2/log/scan.log
echo "分析结束"
awk '{print "共检测到扫描攻击" NR"次"}' $file2/log/scan.log|tail -n1
echo "开始统计扫描攻击事件中，出现频率最多的前20个IP地址"
cat $file2/log/scan.log |awk -F "[" '{print $1}' |sort |uniq -c |sort -rn |head -20 >$file2/ip/scanip.log
echo ---------------------------------------------------------------
more $file2/ip/scanip.log
echo "统计结束"
echo -------------------------敏感文件扫描dir.log-------------------
echo "开始分析存在扫描的攻击行为，并将结果保存在$file2/log/目录下"
more $filepath2/access*.* |egrep "\.zip|\.rar|\.mdb|\.inc|\.sql|\.config|\.bak|/login.inc.php|/.svn/|/mysql/|config.inc.php|\.bak|wwwroot|网站备份|/gf_admin/|/DataBackup/|/Web.config|/web.config|/1.txt|/test.txt" >$file2/log/dir.log
echo "分析结束"
echo "二次分析结果中HTTP响应码为200和500，结果另存为$file2/log/dirok.log"
more $file2/log/dir.log | awk '{if($9=200) {print $1" "$2" "$3" "$4" "$6" "$7" "$8" "$9}}' >$file2/log/dirok.log
more $file2/log/dir.log | awk '{if($9=500) {print $1" "$2" "$3" "$4" "$6" "$7" "$8" "$9}}' >>$file2/log/dirok.log
echo "二次分析结束"
awk '{print "共检测到针对敏感文件扫描" NR"次"}' $file2/log/dir.log|tail -n1
echo "开始统计敏感文件扫描事件中，出现频率最多的前20个IP地址"
cat $file2/log/dir.log |awk -F "[" '{print $1}' |sort |uniq -c |sort -rn |head -20 >$file2/ip/dirip.log
echo ---------------------------------------------------------------
more $file2/ip/dirip.log
echo "统计结束"
echo -------------------------漏洞利用exp.log-------------------
echo "开始分析存在漏洞利用的攻击行为，并将结果保存在$file2/log/目录下"
more $filepath2/access*.* |egrep "struts|jmx-console|ajax_membergroup.php|iis.txt|phpMyAdmin|getWriter|dirContext|phpmyadmin|acunetix.txt|/e/|/SouthidcEditor/|/DatePicker/" >$file2/log/exp.log
echo "分析结束"
awk '{print "共检测到漏洞利用" NR"次"}' $file2/log/exp.log|tail -n1
echo "开始统计漏洞利用攻击事件中，出现频率最多的前20个IP地址"
cat $file2/log/exp.log |awk -F "[" '{print $1}' |sort |uniq -c |sort -rn |head -20 >$file2/ip/expip.log
echo ---------------------------------------------------------------
cat $file2/ip/expip.log
echo "统计结束"
echo -------------------------文件包含lfi.log--------------------
echo "开始分析存在利用文件包含漏洞的攻击行为，并将结果保存在$file2/log/目录下"
more $filepath2/access*.* |egrep "/passwd|%00|/win.ini|/my.ini|/MetaBase.xml|/ServUDaemon.ini|cmd.exe" >$file2/log/lfi.log
echo "分析结束"
echo "二次分析结果中HTTP响应码为200和500，结果另存为$file2/log/lfiok.log"
more $file2/log/lfi.log | awk '{if($9=200) {print $1" "$2" "$3" "$4" "$6" "$7" "$8" "$9}}' >$file2/log/lfiok.log
more $file2/log/lfi.log | awk '{if($9=500) {print $1" "$2" "$3" "$4" "$6" "$7" "$8" "$9}}' >>$file2/log/lfiok.log
echo "二次分析结束"
awk '{print "共检测到LFI本地文件包含" NR"次"}' $file2/log/lfi.log|tail -n1
echo "开始统计漏洞利用攻击事件中，出现频率最多的前20个IP地址"
cat $file2/log/lfi.log |awk -F "[" '{print $1}' |sort |uniq -c |sort -rn |head -20 >$file2/ip/lfiip.log
echo ---------------------------------------------------------------
more $file2/ip/lfiip.log
echo "统计结束"
echo -------------------------getshell-getshell.log----------------
echo "开始分析存在getshell的攻击行为，并将结果保存在$file2/log/目录下"
more $filepath2/access*.* |egrep " eval|%eval|%execute|%3binsert|%20makewebtaski%20|/div.asp|/1.asp|/1.jsp|/1.php|/1.aspx|/xiaoma.jsp|/tom.jsp|/py.jsp|/k8cmd.jsp|/k8cmd|/ver007.jsp|/ver008.jsp|/ver007|/ver008|%if|\.aar" >>$file2/log/getshell.log
echo "分析结束"
echo "二次分析结果中HTTP响应码为200和500，结果另存为$file2/log/getshellok.log"
more $file2/log/getshell.log | awk '{if($9=200) {print $1" "$2" "$3" "$4" "$6" "$7" "$8" "$9}}' >$file2/log/getshellok.log
more $file2/log/getshell.log | awk '{if($9=500) {print $1" "$2" "$3" "$4" "$6" "$7" "$8" "$9}}' >>$file2/log/getshellok.log
echo "二次分析结束"
awk '{print "共检测到getshell行为" NR "次"}' $file2/log/getshell.log|tail -n1
echo "开始统计漏洞利用攻击事件中，出现频率最多的前20个IP地址"
cat $file2/log/getshell.log |awk -F "[" '{print $1}' |sort |uniq -c |sort -rn |head -20 >$file2/ip/getshellip.log
echo ---------------------------------------------------------------
more $file2/ip/getshellip.log
echo "统计结束"
echo -------------------------xss跨站脚本攻击xss.log--------------------
echo "开始分析存在XSS跨站脚本攻击的攻击行为，并将结果保存在$file2/log/目录下"
more $filepath2/access*.* |egrep "<script|javascript| onerror| oneclick| onload|<img|alert|document|cookie" >$file2/log/xss.log
echo "分析结束"
awk '{print "共检测到XSS跨站脚本攻击" NR"次"}' $file2/log/xss.log|tail -n1
echo "开始统计XSS跨站脚本攻击事件中，出现频率最多的前20个IP地址"
cat $file2/log/xss.log |awk -F "[" '{print $1}' |sort |uniq -c |sort -rn |head -20 >$file2/ip/xssip.log
echo ---------------------------------------------------------------
more $file2/ip/xssip.log
echo "统计结束"      
echo "分析已完成，请到$file2/目录下查看结果"
for ofile in *
do
   [ ! -s $ofile ] && rm -f $ofile
done
else
echo "未找到日志文件"
fi
}
menu
function super
{
 
cat <<EOF
        `echo "1).文件名搜索："`   
        `echo "2).IP地址搜索："`  
        `echo "3).返回主菜单："` 
EOF
    read -p "请选择相应的功能：" gn1
    read -p "请输入日志路径：" filepath2
    case "$gn1" in
        1)
        echo "日志内容搜索"
        read -p "请输入要分析的脚本名称：" name66
        if [ -z $name66 ];then
        echo "请输入正确的文件名"
        else
        echo "*******************************检索内容如下：******************************************"
        more $filepath2/access*.* |egrep "/$name66"|grep -v " 404"|awk -F " " '{print "访问IP地址为："$1" ""后门地址为："$7}'|grep -v "Binary"|grep -v "：400"|grep -v " 400 0 "|sort |uniq -c |sort -rn >$filepath2/log/$name66-ip.log
        fl=$(cat $filepath2/log/$name66-ip.log)
        if [ -z $fl ];then
        echo "没有发现匹配$name66的内容"
        rm -rf $filepath2/log/$name66-ip.log
        echo "按回车键重新进行搜索"
        read key
        super
        else
        cat $filepath2/log/$name66-ip.log
        echo "*******************************************************详细列表如下：******************"
        more $filepath2/access*.* |egrep "/$name66"|grep -v " 404"|awk -F " " '{print $name66}'|grep -v "Binary"|grep -v "：400"|grep -v " 400 0 "|sort |uniq -c |sort -rn >$filepath2/log/$name66.log
        cat $filepath2/log/$name66.log
        echo "************************************************************************************"
        fi
        fi
        menu
        ;;
        2)
        echo "IP地址检索："
        read -p "请输入要搜索的IP地址：" ip66
        if [ -z $ip66 ]; then
        echo "请输入正确的IP地址"
        else
        echo "**********************************检索内容如下：**************************************"
        more $filepath2/access*.* |egrep "$ip66"|grep -v " 404"|awk -F " " '{print "访问时间为："$4" "$6" ""链接地址为："$7}'|grep -v "Binary"|grep -v "：400"|grep -v " 400 0 "|sort |uniq -c |sort -rn >$filepath2/log/$ip66-file.log
        fl2=$(cat $filepath2/log/$ip66-file.log)
        if [ -z $fl2 ];then
        echo "没有发现匹配$ip66的内容"
        rm -rf $filepath2/log/$ip66-file.log
        echo "按回车键重新进行搜索"
        read key
        else
        cat $filepath2/log/$ip66-file.log
        echo "*********************************详细列表如下：**********************************"
        more $filepath2/access*.* |egrep "$ip66"|grep -v " 404"|awk -F " " '{print $ip66}'|grep -v "Binary"|grep -v "：400"|grep -v " 400 0 "|sort |uniq -c |sort -rn >$filepath2/log/$ip66.log
        cat $filepath2/log/$ip66.log
        echo "************************************************************************************"
        fi
        fi
        menu
        ;;
        3)
        menu
        ;;
        esac
     
 
}
menu